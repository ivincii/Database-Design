-- Stephen Tucker 
-- Fact Tables

USE DATABASE IMT577_IT_DW_STEPHEN_TUCKER_STAGE



--CLEAR TABLE
TRUNCATE FACT_PRODUCTSALESTARGET;
TRUNCATE FACT_SRCSALESTARGET;
TRUNCATE FACT_SALESACTUAL;

--CHECK TABLE
SELECT * FROM FACT_PRODUCTSALESTARGET;
SELECT * FROM FACT_SRCSALESTARGET;
SELECT * FROM FACT_SALESACTUAL;

--DROP TABLE
DROP TABLE IF EXISTS Fact_ProductSalesTarget;
DROP TABLE IF EXISTS Fact_CRS_SalesTarget;
DROP TABLE IF EXISTS FACT_SALESACTUAL;



--------------------------------------------
--- ProductSALES_Target --------------------------
---------------------------------------------

DROP TABLE Fact_ProductSalesTarget

CREATE OR REPLACE TABLE Fact_ProductSalesTarget
(
    DIMPRODUCTID INTEGER CONSTRAINT FK_DimProductID FOREIGN KEY REFERENCES DIM_PRODUCT(DimProductID)
    ,DateTargetDateID NUMBER(9) CONSTRAINT FK_DIMTARGETDATEID FOREIGN KEY REFERENCES DIM_DATE(DATE_PKEY) --FOREIGN KEY
    ,ProductTargetSalesQuantity FLOAT
);


SELECT * FROM Fact_ProductSalesTarget


INSERT INTO Fact_ProductSalesTarget
(
  DIMPRODUCTID
  ,DateTargetDateID
  ,ProductTargetSalesQuantity
)

SELECT
    NVL(DimProductID, -1) AS ProductID
    ,DATE_PKEY AS DimTargetDateID
    ,(SALESQUANTITYTARGET/ 365) AS ProductTargetSalesQuantity
FROM 
    TARGETPRODUCT
LEFT OUTER JOIN 
    DIM_PRODUCT
ON 
    TARGETPRODUCT.PRODUCTID = DIM_PRODUCT.DIMPRODUCTID
LEFT OUTER JOIN 
    Dim_Date    
ON 
    Dim_Date.YEAR = TARGETPRODUCT.YEAR   
    
    
-- Tables 17520 Working

SELECT * FROM Fact_ProductSalesTarget
Row Counts

-- Fact_SalesActual - 187,320
-- Fact_ProductSalesTarget - 17,520
-- Fact_SRCSalesTarget - 8,030

--------------------
CREATE OR REPLACE TABLE FACT_PRODUCTSALESTARGET 
( 
    DIMPRODUCTID INTEGER CONSTRAINT FK_DIMPRODUCTID FOREIGN KEY REFERENCES DIM_PRODUCT(DIMPRODUCTID) --FOREIGN KEY 
    ,DIMTARGETDATEID NUMBER(9) CONSTRAINT FK_DIMTARGETDATEID FOREIGN KEY REFERENCES DIM_DATE(DATE_PKEY) --FOREIGN KEY 
    ,PRODUCTTARGETSALESQUANTITY INTEGER 
);

--INSERT TABLE
INSERT INTO FACT_PRODUCTSALESTARGET 
( 
    DIMPRODUCTID 
    ,DIMTARGETDATEID 
    ,PRODUCTTARGETSALESQUANTITY 
)

SELECT DISTINCT 
    DIM_PRODUCT.DIMPRODUCTID 
    ,DIM_DATE.DATE_PKEY 
    ,ROUND(TARGETPRODUCT.SALESQUANTITYTARGET/365)
FROM TARGETPRODUCT 
INNER JOIN DIM_PRODUCT ON TARGETPRODUCT.PRODUCTID = DIM_PRODUCT.SOURCEPRODUCTID 
LEFT OUTER JOIN DIM_DATE ON TARGETPRODUCT.YEAR = DIM_DATE.YEAR


-- Current Row Count 17,520 
-- --Fact_ProductSalesTarget - 17,520



--- Fact_CRS_SalesTarget
--------------------------------------------
--- Fact CRS SalesTarget --------------------------
---------------------------------------------
---- Re-Build ------
DELETE FROM Fact_CRS_SalesTarget

CREATE OR REPLACE TABLE Fact_CRS_SalesTarget 
( 
    DIMSTOREID INTEGER CONSTRAINT FK_DIMSTOREID FOREIGN KEY REFERENCES DIM_STORE(DIMSTOREID) --FOREIGN KEY 
    ,DIMRESELLERID INTEGER CONSTRAINT FK_DIMRESELLERID FOREIGN KEY REFERENCES DIM_RESELLER(DIMRESELLERID) --FOREIGN KEY 
    ,DIMCHANNELID INTEGER CONSTRAINT FK_DIMCHANNELID FOREIGN KEY REFERENCES DIM_CHANNEL(DIMCHANNELID) --FOREIGN KEY 
    ,DIMTARGETDATEID NUMBER(9) CONSTRAINT FK_DIMTARGETDATEID FOREIGN KEY REFERENCES DIM_DATE(DATE_PKEY) --FOREIGN KEY 
    ,SALESTARGETAMOUNT NUMBER(38,0));
    
--ADD NEW COLUMN STOREID AND TRANSFORM FROM TARGETNAME
ALTER TABLE TARGETCRS 
ADD STOREID INTEGER

UPDATE TARGETCRS 
SET STOREID = 
    CASE 
    WHEN TARGETNAME = 'Store Number 5' THEN 5 
    WHEN TARGETNAME = 'Store Number 8' THEN 8 
    WHEN TARGETNAME = 'Store Number 10' THEN 10 
    WHEN TARGETNAME = 'Store Number 21' THEN 21 
    WHEN TARGETNAME = 'Store Number 34' THEN 34 
    WHEN TARGETNAME = 'Store Number 39' THEN 39 
    ELSE -1 
    END;

-- Updating table creating 
UPDATE TARGETCRS 
SET CHANNELNAME = 
    CASE 
    WHEN CHANNELNAME = 'On-line' THEN 'Online' 
    ELSE CHANNELNAME 
    END
    
--INSERT TABLE

INSERT INTO Fact_CRS_SalesTarget 
( 
    DIMSTOREID 
    ,DIMRESELLERID 
    ,DIMCHANNELID 
    ,DIMTARGETDATEID 
    ,SALESTARGETAMOUNT )
    
SELECT DISTINCT 
    DIM_STORE.DIMSTOREID 
    ,NVL(DIM_RESELLER.DIMRESELLERID,-1) 
    ,NVL(DIM_CHANNEL.DIMCHANNELID,-1) 
    ,DIM_DATE.DATE_PKEY 
    ,ROUND(TARGETCRS.TARGETSALESAMOUNT/365)
FROM TARGETCRS 
LEFT JOIN DIM_RESELLER ON TARGETCRS.TARGETNAME = DIM_RESELLER.RESELLERNAME 
LEFT JOIN DIM_CHANNEL ON TARGETCRS.CHANNELNAME = DIM_CHANNEL.CHANNELNAME 
LEFT JOIN DIM_STORE ON TARGETCRS.STOREID = DIM_STORE.STORENUMBER 
LEFT JOIN DIM_DATE ON TARGETCRS.YEAR = DIM_DATE.YEAR

SELECT * FROM Fact_CRS_SalesTarget

-- working but has to many rows


-- Number of Rows 15330
-- --Fact_SRCSalesTarget - 8,030
    
-------- FACT SALES ACTUAL -----------------------
SELECT * FROM Fact_SalesActual
DROP TABLE Fact_SalesActual

DimLocationID INTEGER IDENTITY(1,1) CONSTRAINT PK_DimLocationID PRIMARY KEY NOT NULL

CREATE OR REPLACE TABLE Fact_SalesActual
(
    DIMPRODUCTID INTEGER CONSTRAINT FK_DimProductID FOREIGN KEY REFERENCES Dim_Product(DIMPRODUCTID) NOT NULL
    ,DIMSTOREID INTEGER CONSTRAINT FK_DimStoreID FOREIGN KEY REFERENCES DIM_STORE(DIMSTOREID) NOT NULL
    ,DIMRESELLERID INTEGER CONSTRAINT FK_DIMRESELLERID FOREIGN KEY REFERENCES DIM_RESELLER(DIMRESELLERID) NOT NULL
    ,DIMCHANNELID INTEGER CONSTRAINT FK_DIMCHANNELID FOREIGN KEY REFERENCES DIM_CHANNEL(DIMCHANNELID) NOT NULL  
    ,DateSalesDateID NUMBER(9) CONSTRAINT FK_DateSalesDateID FOREIGN KEY REFERENCES DIM_DATE(DATE_PKEY) NOT NULL
    ,DIMLOCATIONID INTEGER CONSTRAINT FK_DIMLOCATIONID FOREIGN KEY REFERENCES DIM_LOCATION(DIMLOCATIONID) NOT NULL
    ,SourceSalesHeader Number(38,0) NOT NULL
    ,SourceSalesDetailID Number(38,0) NOT NULL
    ,SalesAmount FLOAT NOT NULL
    ,SaleQuantity INTEGER NOT NULL
    ,SaleUnitPrice FLOAT NOT NULL
    ,SaleExtendedCost FLOAT NOT NULL
    ,SaleTotalProfit FLOAT NOT NULL
);


INSERT INTO Fact_SalesActual
(
    DIMPRODUCTID
    ,DIMSTOREID
    ,DIMRESELLERID
    ,DIMCHANNELID    
    ,DateSalesDateID
    ,DIMLOCATIONID
    ,SourceSalesHeader -- Do I join my data somehow with source sales header.
    ,SourceSalesDetailID
    ,SalesAmount
    ,SaleQuantity
    ,SaleUnitPrice
    ,SaleExtendedCost
    ,SaleTotalProfit
    
) 

SELECT DISTINCT 
    NVL(DIM_PRODUCT.DIMPRODUCTID, -1) AS ProductID
    ,NVL(STOREID, -1) AS StoreID
    ,NVL(Dim_Reseller.DIMRESELLERID, -1) AS ResellerID
    ,NVL(Dim_Channel.DimChannelID, -1) AS ChannelID 
    ,Dim_Date.DATE_PKEY AS DateSalesID
    ,NVL(DIM_LOCATION.DIMLOCATIONID, -1) AS LocationID
    ,SALESHEADER.SALESHEADERID AS SourceSalesHeader
    ,SALESDETAIL.SALESDETAILID AS SourceSalesDetailID
    ,SALESDETAIL.SALESAMOUNT AS SaleAmount
    ,SALESDETAIL.SALESQUANTITY AS SaleQuantity
    ,SALESDETAIL.SALESQUANTITY / SALESDETAIL.SALESAMOUNT AS SaleUnitPrice
    ,Dim_PRODUCT.ProductCost AS SaleExtendedCost
    ,SALESDETAIL.SALESAMOUNT - Dim_PRODUCT.ProductCost AS SaleTotalProfit
FROM
    SalesHeader
JOIN 
    SalesDetail
ON
    SALESHEADER.SalesHeaderID = SALESDETAIL.SalesHeaderID
LEFT OUTER JOIN 
    DIM_PRODUCT
ON     
    SALESDETAIL.PRODUCTID =  DIM_PRODUCT.DIMPRODUCTID
LEFT OUTER JOIN 
    DIM_RESELLER
ON     
    SALESHEADER.RESELLERID = DIM_RESELLER.DIMRESELLERID
LEFT OUTER JOIN    
    DIM_CHANNEL
ON
    SALESHEADER.CHANNELID = DIM_CHANNEL.DIMCHANNELID
LEFT OUTER JOIN 
    Dim_Date
ON 
    Dim_Date.Date = SALESHEADER.Date
LEFT OUTER JOIN 
    Dim_Location 
ON     
    DIM_LOCATION.DIMLOCATIONID =  DIM_RESELLER.DIMLOCATIONID

-------- Rebuild 

DROP TABLE FACT_SALESACTUAL
--CREATE TABLE
CREATE OR REPLACE TABLE FACT_SALESACTUAL 
( 
    DIMPRODUCTID INTEGER CONSTRAINT FK_DIMPRODUCTID FOREIGN KEY REFERENCES DIM_PRODUCT(DIMPRODUCTID) --FOREIGN KEY 
    ,DIMSTOREID INTEGER CONSTRAINT FK_DIMSTOREID FOREIGN KEY REFERENCES DIM_STORE(DIMSTOREID) --FOREIGN KEY 
    ,DIMRESELLERID INTEGER CONSTRAINT FK_DIMRESELLERID FOREIGN KEY REFERENCES DIM_RESELLER(DIMRESELLERID) --FOREIGN KEY 
    ,DIMCHANNELID INTEGER CONSTRAINT FK_DIMCHANNELID FOREIGN KEY REFERENCES DIM_CHANNEL(DIMCHANNELID) --FOREIGN KEY 
    ,DIMSALESDATEID NUMBER(9) CONSTRAINT FK_DIMTARGETDATEID FOREIGN KEY REFERENCES DIM_DATE(DATE_PKEY) --FOREIGN KEY 
    ,DIMLOCATIONID INTEGER CONSTRAINT FK_DIMLOCATIONID FOREIGN KEY REFERENCES Dim_Location (DimLocationID) --FOREIGN KEY 
    ,SOURCESALESHEADERID INTEGER 
    ,SOURCESALESDETAILID INTEGER 
    ,SALESAMOUNT FLOAT
    ,SALESQUANTITY NUMBER(38,0) 
    ,SALESUNITPRICE FLOAT
    ,SALESEXTENDEDCOST FLOAT
    ,SALESTOTALPROFIT FLOAT 
);
    
--INSERT TABLE

INSERT INTO FACT_SALESACTUAL 
( 
    DIMPRODUCTID 
    ,DIMSTOREID 
    ,DIMRESELLERID     
    ,DIMCHANNELID 
    ,DIMSALESDATEID 
    ,DIMLOCATIONID 
    ,SOURCESALESHEADERID 
    ,SOURCESALESDETAILID 
    ,SALESAMOUNT 
    ,SALESQUANTITY 
    ,SALESUNITPRICE 
    ,SALESEXTENDEDCOST 
    ,SALESTOTALPROFIT )
    
SELECT DISTINCT 
    DIM_PRODUCT.DIMPRODUCTID 
    ,NVL(DIM_STORE.DIMSTOREID,-1) 
    ,NVL(DIM_RESELLER.DIMRESELLERID,-1) 
    ,NVL(DIM_CHANNEL.DIMCHANNELID,-1) 
    ,DIM_DATE.DATE_PKEY 
    ,NVL(Dim_Location.DimLocationID,-1) 
    ,SALESHEADER.SALESHEADERID 
    ,SALESDETAIL.SALESDETAILID 
    ,SALESDETAIL.SALESAMOUNT 
    ,SALESDETAIL.SALESQUANTITY 
    ,SALESDETAIL.SALESAMOUNT/SALESDETAIL.SALESQUANTITY 
    ,DIM_PRODUCT.PRODUCTCOST*SALESDETAIL.SALESQUANTITY 
    ,SALESDETAIL.SALESAMOUNT-DIM_PRODUCT.PRODUCTCOST*SALESDETAIL.SALESQUANTITY 
    FROM SALESHEADER 
    LEFT JOIN SALESDETAIL ON SALESHEADER.SALESHEADERID = SALESDETAIL.SALESHEADERID 
    LEFT JOIN DIM_PRODUCT ON SALESDETAIL.PRODUCTID = DIM_PRODUCT.DIMPRODUCTID 
    LEFT JOIN DIM_STORE ON SALESHEADER.STOREID = DIM_STORE.DIMSTOREID 
    LEFT JOIN DIM_RESELLER ON SALESHEADER.RESELLERID = DIM_RESELLER.DIMRESELLERID 
    LEFT JOIN DIM_CHANNEL ON SALESHEADER.CHANNELID = DIM_CHANNEL.DIMCHANNELID 
    LEFT OUTER JOIN DIM_DATE ON SALESHEADER.DATE = DIM_DATE.DATE 
    LEFT JOIN Dim_Location ON DIM_STORE.DimLocationID = Dim_Location.DimLocationID 
    OR DIM_RESELLER.DimLocationID = Dim_Location.DimLocationID 
    
    

------
DROP TABLE FACT_SALESACTUAL

CREATE OR REPLACE TABLE FACT_SALESACTUAL 
( 
    DIMPRODUCTID INTEGER CONSTRAINT FK_DIMPRODUCTID FOREIGN KEY REFERENCES DIM_PRODUCT(DIMPRODUCTID) --FOREIGN KEY 
    ,DIMSTOREID INTEGER CONSTRAINT FK_DIMSTOREID FOREIGN KEY REFERENCES DIM_STORE(DIMSTOREID) --FOREIGN KEY  
    ,DIMCHANNELID INTEGER CONSTRAINT FK_DIMCHANNELID FOREIGN KEY REFERENCES DIM_CHANNEL(DIMCHANNELID) --FOREIGN KEY 
    ,DIMSALESDATEID NUMBER(9) CONSTRAINT FK_DIMTARGETDATEID FOREIGN KEY REFERENCES DIM_DATE(DATE_PKEY) --FOREIGN KEY 
    ,DIMLOCATIONID INTEGER CONSTRAINT FK_DIMLOCATIONID FOREIGN KEY REFERENCES Dim_Location (DimLocationID) --FOREIGN KEY 
    ,SOURCESALESHEADERID INTEGER 
    ,SOURCESALESDETAILID INTEGER 
    ,SALESAMOUNT FLOAT
    ,SALESQUANTITY NUMBER(38,0) 
    ,SALESUNITPRICE FLOAT
    ,SALESEXTENDEDCOST FLOAT
    ,SALESTOTALPROFIT FLOAT 
);
    

INSERT INTO FACT_SALESACTUAL 
( 
    DIMPRODUCTID 
    ,DIMSTOREID      
    ,DIMCHANNELID 
    ,DIMSALESDATEID 
    ,DIMLOCATIONID 
    ,SOURCESALESHEADERID 
    ,SOURCESALESDETAILID 
    ,SALESAMOUNT 
    ,SALESQUANTITY 
    ,SALESUNITPRICE 
    ,SALESEXTENDEDCOST 
    ,SALESTOTALPROFIT )
    
SELECT DISTINCT 
    DIM_PRODUCT.DIMPRODUCTID 
    ,NVL(DIM_STORE.DIMSTOREID,-1) 
    ,NVL(DIM_CHANNEL.DIMCHANNELID,-1) 
    ,DIM_DATE.DATE_PKEY 
    ,NVL(Dim_Location.DimLocationID,-1) 
    ,SALESHEADER.SALESHEADERID 
    ,SALESDETAIL.SALESDETAILID 
    ,SALESDETAIL.SALESAMOUNT 
    ,SALESDETAIL.SALESQUANTITY 
    ,SALESDETAIL.SALESAMOUNT/SALESDETAIL.SALESQUANTITY 
    ,DIM_PRODUCT.PRODUCTCOST*SALESDETAIL.SALESQUANTITY 
    ,SALESDETAIL.SALESAMOUNT-DIM_PRODUCT.PRODUCTCOST*SALESDETAIL.SALESQUANTITY 
    FROM SALESHEADER 
    LEFT JOIN SALESDETAIL ON SALESHEADER.SALESHEADERID = SALESDETAIL.SALESHEADERID 
    LEFT JOIN DIM_PRODUCT ON SALESDETAIL.PRODUCTID = DIM_PRODUCT.DIMPRODUCTID 
    LEFT JOIN DIM_STORE ON SALESHEADER.STOREID = DIM_STORE.DIMSTOREID 
    LEFT JOIN DIM_CHANNEL ON SALESHEADER.CHANNELID = DIM_CHANNEL.DIMCHANNELID 
    LEFT OUTER JOIN DIM_DATE ON SALESHEADER.DATE = DIM_DATE.DATE 
    LEFT JOIN Dim_Location ON DIM_STORE.DimLocationID = Dim_Location.DimLocationID 
 

SELECT * FROM FACT_SALESACTUAL 


-----

--Fact_SalesActual - 187,320
--Fact_ProductSalesTarget - 17,520
--Fact_SRCSalesTarget - 8,030
